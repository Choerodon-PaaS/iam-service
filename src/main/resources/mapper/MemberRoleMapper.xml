<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.iam.infra.mapper.MemberRoleMapper">
    <resultMap id="clientWithRoles" type="io.choerodon.iam.infra.dataobject.ClientDO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <collection property="roles" ofType="io.choerodon.iam.infra.dataobject.RoleDO" columnPrefix="role_">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="code" column="code"/>
            <result property="enabled" column="is_enabled"/>
            <result property="builtIn" column="is_built_in"/>
        </collection>
    </resultMap>

    <select id="selectClientsWithRoles" resultMap="clientWithRoles">
        SELECT
        client.NAME as name,
        client.ID as id,
        role.IS_ENABLED as role_is_enable,
        role.ID as role_id,
        role.NAME as role_name,
        role.CODE as role_code,
        role.IS_BUILT_IN as role_is_built_in
        FROM oauth_client client
        INNER JOIN iam_member_role imr ON client.ID = imr.MEMBER_ID
        INNER JOIN iam_role role ON imr.ROLE_ID = role.ID
        WHERE imr.MEMBER_TYPE = 'client'
        <if test="sourceId != null">
            AND imr.source_id = #{sourceId}
        </if>
        <if test="sourceType != null">
            AND imr.source_type = #{sourceType}
        </if>
        <if test="clientRoleSearchDTO != null">
            <if test="clientRoleSearchDTO.clientName != null">
                AND client.NAME LIKE CONCAT('%', CONCAT(#{clientRoleSearchDTO.clientName}, '%'))
            </if>
            <if test="clientRoleSearchDTO.roleName != null">
                AND role.NAME LIKE CONCAT('%', CONCAT(#{clientRoleSearchDTO.roleName}, '%'))
            </if>
        </if>
        <if test="param != null">
            AND ( client.NAME LIKE concat(concat('%',#{param}),'%')
            OR client.ADDITIONAL_INFORMATION LIKE concat(concat('%',#{param}),'%')
            OR client.AUTHORIZED_GRANT_TYPES LIKE concat(concat('%',#{param}),'%')
            OR role.name LIKE concat(concat('%',#{param}),'%')
            )
        </if>
    </select>

    <delete id="deleteMemberRoleByMemberIdAndMemberType">
        DELETE
        FROM iam_member_role imr
        WHERE imr.MEMBER_ID = #{memberId}
          AND imr.MEMBER_TYPE = #{memberType}
    </delete>

    <select id="selectDeleteList" resultType="java.lang.Long">
        SELECT id FROM iam_member_role
        WHERE member_id = #{mi}
        AND member_type = 'user'
        AND source_id = #{si}
        AND source_type = #{st}
        AND role_id in
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectCountBySourceId" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT source_id)
        FROM iam_member_role
        WHERE iam_member_role.member_id = #{id}
          AND iam_member_role.source_type = #{type}
    </select>

</mapper>
